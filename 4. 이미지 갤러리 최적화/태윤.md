# 04. ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ìµœì í™”

[https://github.com/performance-lecture/lecture-4](https://github.com/performance-lecture/lecture-4)

## âœ¨Â í‚¤ì›Œë“œ

- ì´ë¯¸ì§€ ì§€ì—° ë¡œë”©
- ë ˆì´ì•„ì›ƒ ì´ë™ í”¼í•˜ê¸°
- ë¦¬ë•ìŠ¤ ë Œë”ë§ ìµœì í™”
- ë³‘ëª© ì½”ë“œ ìµœì í™”

## ğŸ¤”Â 1. ì½”ë“œ ë¶„ì„

### ğŸ»Â PhotoListContainer ì»´í¬ë„ŒíŠ¸

```jsx
import React, { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import PhotoList from '../components/PhotoList';
import { fetchPhotos } from '../redux/photos';

function PhotoListContainer() {
  const dispatch = useDispatch();

  useEffect(() => {
    dispatch(fetchPhotos());
  }, [dispatch]);

  const { photos, loading } = useSelector(state => ({
    photos:
      state.category.category === 'all'
        ? state.photos.data
        : state.photos.data.filter(
            photo => photo.category === state.category.category
          ),
    loading: state.photos.loading,
  }));

  if (loading === 'error') {
    return <span>Error!</span>;
  }

  if (loading !== 'done') {
    return <span>loading...</span>;
  }

  return <PhotoList photos={photos} />;
}

export default PhotoListContainer;

```

### ğŸ»Â PhotoItem ì»´í¬ë„ŒíŠ¸

```jsx
import React from 'react';
import styled from 'styled-components';
import { useDispatch } from 'react-redux';
import { showModal } from '../redux/imageModal';

function PhotoItem({ photo: { urls, alt } }) {
  const dispatch = useDispatch();

  const openModal = () => {
    dispatch(showModal({ src: urls.full, alt }));
  };

  return (
    <ImageWrap>
      <Image src={urls.small + '&t=' + new Date().getTime()} alt={alt} onClick={openModal} />
    </ImageWrap>
  );
}

const ImageWrap = styled.div``;

const Image = styled.img`
  cursor: pointer;
  width: 100%;
`;

export default PhotoItem;

```

### ğŸ»Â imageModal ìŠ¤í† ì–´

```jsx
import { createSlice } from '@reduxjs/toolkit';

/** Actions **/
export const SHOW_MODAL = 'SHOW_MODAL';
export const HIDE_MODAL = 'HIDE_MODAL';
export const SET_BG_COLOR = 'SET_BG_COLOR';

export const showModal = ({ src, alt }) => ({
  type: SHOW_MODAL,
  src,
  alt,
});
export const hideModal = () => ({ type: HIDE_MODAL });
export const setBgColor = bgColor => ({ type: SET_BG_COLOR, bgColor });

/** Reducer **/
const { reducer: imageModalReducer } = createSlice({
  name: 'imageModal',
  initialState: {
    modalVisible: false,
    bgColor: { r: 0, g: 0, b: 0 },
    src: '',
    alt: '',
  },
  reducers: {},
  extraReducers: {
    SHOW_MODAL: (state, action) => {
      state.modalVisible = true;
      state.src = action.src;
      state.alt = action.alt;
      state.bgColor = { r: 0, g: 0, b: 0 };
    },
    HIDE_MODAL: state => {
      state.modalVisible = false;
    },
    SET_BG_COLOR: (state, action) => {
      state.bgColor = action.bgColor;
    },
  },
});

export default imageModalReducer;

```

### ğŸ»Â ImageModal ì»´í¬ë„ŒíŠ¸

```jsx
import React from 'react';
import styled from 'styled-components';
import Modal from './Modal';
import { useDispatch } from 'react-redux';
import { hideModal, setBgColor } from '../redux/imageModal';
import { getAverageColorOfImage } from '../utils/getAverageColorOfImage';

function ImageModal({ modalVisible, src, alt, bgColor }) {
  const dispatch = useDispatch();
  const onLoadImage = e => {
    const averageColor = getAverageColorOfImage(e.target);
    dispatch(setBgColor(averageColor));
  };

  const closeModal = () => {
    dispatch(hideModal());
  };

  return (
    <Modal
      modalVisible={modalVisible}
      closeModal={closeModal}
      bgColor={bgColor}
    >
      <ImageWrap>
        <FullImage crossOrigin="*" src={src} alt={alt} onLoad={onLoadImage} />
      </ImageWrap>
    </Modal>
  );
}

const ImageWrap = styled.div`
  width: 100%;
  height: 100%;
`;
const FullImage = styled.img`
  max-width: 100vw;
  max-height: 75vh;
  box-shadow: 0px 0px 16px 4px rgba(0, 0, 0, 0.3);
`;

export default ImageModal;

```

### ğŸ»Â getAverageColorOfImage í•¨ìˆ˜

```jsx
export function getAverageColorOfImage(imgElement) {
  const canvas = document.createElement('canvas');
  const context = canvas.getContext && canvas.getContext('2d');
  const averageColor = {
    r: 0,
    g: 0,
    b: 0,
  };

  if (!context) {
    return averageColor;
  }

  const width = (canvas.width =
    imgElement.naturalWidth || imgElement.offsetWidth || imgElement.width);
  const height = (canvas.height =
    imgElement.naturalHeight || imgElement.offsetHeight || imgElement.height);

  context.drawImage(imgElement, 0, 0);

  const imageData = context.getImageData(0, 0, width, height).data;
  const length = imageData.length;

  for (let i = 0; i < length; i += 4) {
    averageColor.r += imageData[i];
    averageColor.g += imageData[i + 1];
    averageColor.b += imageData[i + 2];
  }

  const count = length / 4;
  averageColor.r = ~~(averageColor.r / count); // ~~ => convert to int
  averageColor.g = ~~(averageColor.g / count);
  averageColor.b = ~~(averageColor.b / count);

  return averageColor;
}

```

## ğŸš—Â 2. ë ˆì´ì•„ì›ƒ ì´ë™ í”¼í•˜ê¸°

### ğŸ»Â ë ˆì´ì•„ì›ƒ ì´ë™ì´ë€ ?

- ìš”ì†Œ ë³€í™”ë¡œ ë ˆì´ì•„ì›ƒì´ ê°‘ìê¸° ë°€ë¦¬ëŠ” í˜„ìƒ
    
    â‡’ ì‚¬ìš©ìì˜ ì£¼ì˜ë¥¼ ì‚°ë§Œí•˜ê²Œ ë§Œë“¤ê³  ìœ„ì¹˜ë¥¼ ìˆœê°„ì ìœ¼ë¡œ ë³€ê²½ì‹œí‚¤ë©´ì„œ ì˜ë„ì™€ ë‹¤ë¥¸ í´ë¦­ì„ ìœ ë°œí•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì‚¬ìš©ì ê²½í—˜ì— ì•ˆ ì¢‹ì€ ì˜í–¥ì„ ì¤Œ.
    
- Lighthouse CLS(Cumulative Layout Shift) ì§€í‘œë¥¼ í†µí•´ ë ˆì•„ì•„ì›ƒ ì´ë™ ì •ë„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ
    - 0 ~ 1
    - 0: ë ˆì•„ì•„ì›ƒ ì´ë™ì´ ë°œìƒí•˜ì§€ ì•Šì€ ìƒíƒœ
    - 1: ë°˜ëŒ€
    - 0.1 ì´í•˜ë¥¼ ê¶Œì¥

### ğŸ»Â ë ˆì´ì•„ì›ƒ ì´ë™ì˜ ì›ì¸

- ì‚¬ì´ì¦ˆê°€ ë¯¸ë¦¬ ì •ì˜ë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ ìš”ì†Œ
- ì‚¬ì´ì¦ˆê°€ ë¯¸ë¦¬ ì •ì˜ë˜ì§€ ì•Šì€ ê´‘ê³  ìš”ì†Œ
- ë™ì ìœ¼ë¡œ ì‚½ì…ëœ ì½˜í…ì¸ 
- ì›¹ í°íŠ¸

ì‚¬ì´ì¦ˆê°€ ë¯¸ë¦¬ ì •ì˜ë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ ìš”ì†Œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì´ë¯¸ì§€ ìš”ì†Œì˜ ì‚¬ì´ì¦ˆë¥¼ ë¯¸ë¦¬ ì •ì˜í•´ì£¼ë©´ ë¨.

- padding-top
- aspect-ratio

í˜„ì¬ ì´ë¯¸ì§€ëŠ” ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ì´ì¦ˆê°€ ë³€ê²½ë˜ë©° 16 : 9 ì‚¬ì´ì¦ˆë¡œ ì´ë¯¸ì§€ê°€ ë³´ì—¬ì§€ê³  ìˆë‹¤.

```css
/* padding */

.wrapper {
	position: relative;
	width: 160px;
	padding-top: 56.25%;
}

.image {
	position: absolute;
	width: 100%;
	height: 100%;
	top: 0;
	left: 0;
}

/* aspect-ratio */
.wrapper {
	width: 100%;
	aspect-ratio: 16 / 9;
}

.image {
	width: 100%;
	height: 100%;
}
```

## ğŸ–¼ï¸Â 3. ì´ë¯¸ì§€ ì§€ì—° ë¡œë”©

### ğŸ»Â react-lazyload

intersection observer apiê°€ ì•„ë‹Œ react-lazyload ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•˜ì—¬ ì´ë¯¸ì§€ ì§€ì—° ë¡œë”©ì„ ì ìš©í•  ìˆ˜ ìˆìŒ.

```jsx
import LazyLoad from "react-lazyload";

function Component() {
	return (
		<div>
			{/* í•´ë‹¹ ë¶€ë¶„ì´ ìŠ¤í¬ë¡¤ì„ í†µí•´ í™”ë©´ì— ë“¤ì–´ì˜¤ëŠ” ìˆœê°„ ë¡œë“œ */}
			<LazyLoad>
				<img src="ì´ë¯¸ì§€ ì£¼ì†Œ" />
			</LazyLoad>
		</div>
	)
}
```

ì§€ì—° ë¡œë”©í•  ë•Œ ìŠ¤í¬ë¡¤ í•˜ë©´ ì´ë¯¸ì§€ê°€ ë¡œë”©ë˜ê¸° ë•Œë¬¸ì— ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ offset ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

```jsx
import LazyLoad from "react-lazyload";

function Component() {
	return (
		<div>
			{/* 1000px ì „ì— ì´ë¯¸ì§€ë¥¼ ë¡œë“œ */}
			<LazyLoad offset={1000}>
				<img src="ì´ë¯¸ì§€ ì£¼ì†Œ" />
			</LazyLoad>
		</div>
	)
}
```

## ğŸ Â 4. ë¦¬ë•ìŠ¤ ë Œë”ë§ ìµœì í™”

### ğŸ»Â ë¦¬ì•¡íŠ¸ì˜ ë Œë”ë§

- ë¦¬ì•¡íŠ¸ëŠ” ë Œë”ë§ ì‚¬ì´í´ì„ ê°–ìœ¼ë©°, ì„œë¹„ìŠ¤ì˜ ìƒíƒœê°€ ë³€ê²½ë˜ë©´ í™”ë©´ì— ë°˜ì˜í•˜ê¸° ìœ„í•´ ë¦¬ë Œë”ë§ ê³¼ì •ì„ ê±°ì¹œë‹¤
- ë Œë”ë§ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì½”ë“œê°€ ìˆê±°ë‚˜ ë Œë”ë§í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¶ˆí•„ìš”í•˜ê²Œ ë¦¬ë Œë”ë§ì´ ë°œìƒí•˜ë©´ ë©”ì¸ ìŠ¤ë ˆë“œì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¨ì§€í•˜ì—¬ ì„œë¹„ìŠ¤ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤€ë‹¤.

### ğŸ»Â ë¬¸ì œ ì •ì˜

- React Developer Tools ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ë Œë”ë§ì„ í™•ì¸í•˜ë©´, ì´ë¯¸ì§€ ëª¨ë‹¬ì„ ë„ì› ì„ ë•Œ ëª¨ë‹¬ë§Œ ë Œë”ë§ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸ê¹Œì§€ ë¦¬ë Œë”ë§ëœë‹¤.

### ğŸ»Â ë¦¬ë Œë”ë§ì˜ ì›ì¸

- ì„œë¹„ìŠ¤ì—ì„œ ë¦¬ë•ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ”ë°, ë¦¬ë•ìŠ¤ì˜ ìƒíƒœë¥¼ êµ¬ë…í•˜ê³  ìˆëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë•ìŠ¤ ìƒíƒœ ë³€í™”ì— ë”°ë¼ ë¶ˆí•„ìš”í•˜ê²Œ ë¦¬ë Œë”ë§ë˜ê³  ìˆìŒ.

- `useSelector` í›…ì˜ ë™ì‘ ë°©ì‹ì— ì˜í•´ ìœ„ì™€ ê°™ì€ ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ì´ ë°œìƒí•˜ê³  ìˆìŒ.
    - useSelector ëŠ” ì„œë¡œ ë‹¤ë¥¸ ìƒíƒœë¥¼ ì°¸ì¡°í•  ë•ŒëŠ” ë¦¬ë Œë”ë§ì„ í•˜ì§€ ì•Šì§€ë§Œ, ê·¸ íŒë‹¨ì˜ ê¸°ì¤€ì´ useSelectorì˜ ì¸ìë¡œ ë„£ì€ í•¨ìˆ˜ì˜ ë°˜í™˜ê°’
    
    ```jsx
    const { photos, loading } = useSelector(state => ({
      photos:
        state.category.category === 'all'
    			? state.photos.data
    			: state.photos.data.filter(
    		photo => photo.category === state.category.category
    	),
    	loading: state.photos.loading,
    }));
    
    const { modalVisible, bgColor, src, alt } = useSelector(state => ({
    	modalVisible: state.imageModal.modalVisible,
    	bgColor: state.imageModal.bgColor,
    	src: state.imageModal.src,
    	alt: state.imageModal.alt,
    }));
    ```
    
    â‡’ ê°ì²´ë¥¼ ë°˜í™˜í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ìƒˆë¡œìš´ ì°¸ì¡° ê°’ì„ ë°˜í™˜
    

### ğŸ»Â ë¬¸ì œ í•´ê²°

- ê°ì²´ë¥¼ ìƒˆë¡œ ë§Œë“¤ì§€ ì•Šë„ë¡ ë°˜í™˜ ê°’ì„ ë‚˜ëˆ„ê¸°
    
    ```jsx
    // ì´ì „
    const { modalVisible, bgColor, src, alt } = useSelector(state => ({
    	modalVisible: state.imageModal.modalVisible,
    	bgColor: state.imageModal.bgColor,
    	src: state.imageModal.src,
    	alt: state.imageModal.alt,
    }));
    
    // ì´í›„
    const modalVisible = useSelector(state => state.imageModal.modalVisible)
    const bgColor = useSelector(state => state.imageModal.bgColor)
    const src = useSelector(state => state.imageModal.src)
    const alt = useSelector(state => state.imageModal.alt)
    ```
    
- Equality Function ì‚¬ìš©
    
    ```jsx
    // ì´ì „
    const { modalVisible, bgColor, src, alt } = useSelector(state => ({
    	modalVisible: state.imageModal.modalVisible,
    	bgColor: state.imageModal.bgColor,
    	src: state.imageModal.src,
    	alt: state.imageModal.alt,
    }));
    
    // ì´í›„
    const { modalVisible, bgColor, src, alt } = useSelector(state => ({
    	modalVisible: state.imageModal.modalVisible,
    	bgColor: state.imageModal.bgColor,
    	src: state.imageModal.src,
    	alt: state.imageModal.alt,
    }), shallowEqual);
    ```
    
    - shallowEqual ì˜µì…˜ì„ í†µí•´ ê°ì²´ë¥¼ ì•ì€ ë¹„êµí•  ìˆ˜ ìˆìŒ.

## ğŸ’¥Â 5. ë³‘ëª© ì½”ë“œ ìµœì í™”

- ë©”ëª¨ì´ì œì´ì…˜
    
    ```jsx
    const cache = {};
    
    export function getAverageColorOfImage(imgElement) {
    	// ìºì‹±
    	if (cache.hasOwnProperty(imgElement.src)) {
    		return cache[imageElement.src];
    	}
    	
    	// ë¡œì§
    	
    	cache[imgElement.src] = averageColor;
    
      return averageColor;
    }
    ```
    
- í•¨ìˆ˜ì˜ ë¡œì§ ê°œì„ 
    - ê¸°ì¡´ì—ëŠ” canvasì—ì„œ ëª¨ë‹¬ë¡œ ë„ìš°ëŠ” ì „ì²´ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í–ˆì§€ë§Œ, ì´ë¯¸ì§€ì˜ ì‚¬ì´ì¦ˆë¥¼ ì¤„ì´ë©´ ì†ë„ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤. ê¸°ì¡´ ì¸ë„¤ì¼ì—ì„œ ì‚¬ìš©í–ˆë˜ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ì „ë³´ë‹¤ í•¨ìˆ˜ì˜ ì†ë„ë¥¼ ë¹ ë¥´ê²Œ í•  ìˆ˜ ìˆë‹¤.